---
title: "Laravel Broadcastingã¨Pusherã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ UIæ›´æ–°ã‚’è©¦ã™"
emoji: "ğŸ“£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Laravel", "PHP", "pusher", "broadcasting", "Tech"]
published: true
---

# è¨˜äº‹ã«ã¤ã„ã¦

Laravel ã® Broadcasting ã¨ Pusher ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã® UI æ›´æ–°ã‚’ãŸã‚ã—ã¦ã¿ãŸè¨˜äº‹ã§ã™ ğŸ˜º
ä½•ã‹æ”¹å–„ç‚¹ãªã©ã‚ã‚Œã°ã”æŒ‡æ‘˜ãã ã•ã„ ğŸ™

# Laravel Broadcasting ã«ã¤ã„ã¦ã®èª¬æ˜

[Laravel 10.x Broadcasting](https://laravel.com/docs/10.x/broadcasting)

> In many modern web applications, WebSockets are used to implement realtime, live-updating user interfaces. When some data is updated on the server, a message is typically sent over a WebSocket connection to be handled by the client. This provides a more robust, efficient alternative to continually polling your application for changes.

> æœ€è¿‘ã®å¤šãã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ©ã‚¤ãƒ–æ›´æ–°ã•ã‚Œã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã« WebSocket ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ä¸Šã®ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã€é€šå¸¸ã€WebSocket æ¥ç¶šã‚’ä»‹ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã‚’ç¶™ç¶šçš„ã«ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ã‚ˆã‚Šã‚‚ã€ã‚ˆã‚Šå …ç‰¢ã§åŠ¹ç‡çš„ãªä»£æ›¿æ‰‹æ®µã‚’æä¾›ã—ã¾ã™ã€‚

æŠœãå‡ºã™ã¨ã€â†“ ã¨ã„ã†æ„Ÿã˜ã§ã—ã‚‡ã†ã‹ã€‚

- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã« UI ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã« WebSocket æ¥ç¶šã«ã‚ˆã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹
  - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå®šæœŸçš„ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ DB ã‚’è¦‹ã«ã„ãã‚ˆã‚Šã‚‚åŠ¹ç‡çš„
- Laravel ã§ã¯ WebSocket æ¥ç¶šã‚’ä»‹ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã§ãã‚‹

# Pusher ã®ç™»éŒ²

https://pusher.com/ ã‹ã‚‰ç™»éŒ²ã—ã¾ã™ã€‚

# Laravel å´ã®è¨­å®š

## Laravel ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

ä»Šå›ã¯ Laravel Sail ã‚’ç”¨ã„ã¦ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

â†“ ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã€‚
`curl -s "https://laravel.build/realtime_laravel" | bash`

## Provider æœ‰åŠ¹åŒ–

ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€`config/app.php`ã®`BroadcastServiceProvider`ã®è¡Œã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã¾ã™ã€‚

```PHP:config/app.php
        App\Providers\AppServiceProvider::class,
        App\Providers\AuthServiceProvider::class,
        // App\Providers\BroadcastServiceProvider::class,ã€€â†ã“ã‚Œ
        App\Providers\EventServiceProvider::class,
        App\Providers\RouteServiceProvider::class,
    ])->toArray(),
```

## Laravel ã« Pusher ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‰ãƒ©ã‚¤ãƒã« Pusher ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€Pusher ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
`composer require pusher/pusher-php-server`

## .env ã« Pusher ã®æƒ…å ±ã‚’è¨˜è¼‰ã™ã‚‹

Pusher ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã‚’`.env`ã«è¿½è¨˜ã—ã¾ã™ã€‚

```.env
PUSHER_APP_ID=
PUSHER_APP_KEY=
PUSHER_APP_SECRET=
PUSHER_APP_CLUSTER=
```

ã¾ãŸã€ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‰ãƒ©ã‚¤ãƒã‚‚`log`â†’`pusher`ã«å¤‰æ›´ã—ã¦ãŠãã¾ã™ã€‚
`BROADCAST_DRIVER=pusher`

## Event ã®ä½œæˆ

`php artisan make:event MyEvent`ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

å‡ºæ¥ä¸ŠãŒã£ãŸ`app/Events/MyEvent.php`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã™ã€‚

```PHP:app/config/MyEvent.php
<?php

namespace App\Events;

use Illuminate\Queue\SerializesModels;
use Illuminate\Foundation\Events\Dispatchable;
use Illuminate\Broadcasting\InteractsWithSockets;
use Illuminate\Contracts\Broadcasting\ShouldBroadcast;

class MyEvent implements ShouldBroadcast
{
    use Dispatchable, InteractsWithSockets, SerializesModels;

    public $message;

    public function __construct($message)
    {
        $this->message = $message;
    }

    public function broadcastOn()
    {
        return ['my-channel'];
    }

    public function broadcastAs()
    {
        return 'my-event';
    }
}
```

ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã§ã¯`ShouldBroadcast`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã€`broadcastOn`ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

`boradcastAs`ã§ã¯ã€ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã®åå‰ã‚’`my-event`ã¨ã„ã†åå‰ã«ã—ã¦ã„ã¾ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ã€ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆåã¯ã‚¯ãƒ©ã‚¹åã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®è¨­å®š

## View ã®ä½œæˆ

ä»Šå›ã¯ãŠè©¦ã—ãªã®ã§ã€`welcome.blade.php`ã‚’æ”¹é€ ã—ã¾ã™ã€‚

```PHP:resources/views/welcome.blade.php
<!DOCTYPE html>

<head>
    <title>Pusher Test</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script>

        // Enable pusher logging - don't include this in production
        Pusher.logToConsole = true;

        var pusher = new Pusher("{{ $key }}", {
            cluster: "{{ $cluster }}"
        });

        var channel = pusher.subscribe('my-channel');
        channel.bind('my-event', function (data) {
            console.log(JSON.stringify(data));
        });
    </script>
</head>

<body>
    <h1>Pusher Test</h1>
    <p>
        Try publishing an event to channel <code>my-channel</code>
        with event name <code>my-event</code>.
    </p>
</body>
```

â†“ ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªç”»é¢ã§ã™ã€‚
![ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ç”»é¢](https://storage.googleapis.com/zenn-user-upload/426fbca3bce9-20231210.png)

## Hello Wolrd ã‚’é€ã£ã¦ã¿ã‚‹ãƒ†ã‚¹ãƒˆ

ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã—ã¾ã™ã€‚  
ä»Šå›ã¯ã€`http://localhost/test`ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ãŸã‚‰ã€ã‚¤ãƒ™ãƒ³ãƒˆãŒãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```PHP:routs/web.php
<?php

use Illuminate\Support\Facades\Route;
use \App\Events\MyEvent;

Route::get('/', function () {
    return view('welcome', ['key' => env('PUSHER_APP_KEY'), 'cluster' => env('PUSHER_APP_CLUSTER')]);
});

Route::get('/test', function () {
    event(new MyEvent('Hello World'));
});

```

â†“
![Hello Worldã®ãƒ†ã‚¹ãƒˆ](https://storage.googleapis.com/zenn-user-upload/960bf82cf020-20231210.gif)

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã€ŒHello Worldã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ ğŸ˜¼

## å—ã‘å–ã£ãŸã‚‚ã®ã‚’ç”»é¢ã«è¡¨ç¤ºã•ã›ã‚‹

ã¡ã‚‡ã£ã¨å—ã‘å–ã£ãŸã‚‚ã®ã‚’ç”»é¢ã«è¡¨ç¤ºã•ã›ã¦ã¿ã¾ã—ã‚‡ã†ï¼

```PHP:resources/views/welcome.blade.php
channel.bind('my-event', function (data) {
    document.getElementById('message').innerHTML = data.message;
});

<body>
    <h1>Pusher Test</h1>
    <div id="message"></div>
</body>
```

![Hello Worldã‚’è¡¨ç¤ºã•ã›ã¦ã¿ã‚‹](https://storage.googleapis.com/zenn-user-upload/050aaa8dd74e-20231210.gif)

è¡¨ç¤ºã•ã‚Œã¾ã—ãŸï¼

# DB ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ UI ã‚‚æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«

ä»Šåº¦ã¯ã€DB ã«å¤‰æ›´ãŒã‚ã£ãŸã¨ãã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã« UI ã‚’æ›´æ–°ã—ã¦ã¿ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
![ãƒ†ãƒ¼ãƒ–ãƒ«](https://storage.googleapis.com/zenn-user-upload/03110a53bae6-20231211.png)

ç¾åœ¨ã®åœ¨åº«ï¼ˆ`stock_quantity`ï¼‰ã‚’è¡¨ç¤ºã—ã¦ãŠãã€åœ¨åº«æ•°ã«å¤‰æ›´ãŒã‚ã£ãŸã‚‰ UI ã‚’æ›´æ–°ã™ã‚‹ã®ãŒç›®æ¨™ã§ã™ ğŸ˜º

ãƒ¢ãƒ‡ãƒ«ã¯ â†“ ã§ã™ã€‚

```PHP:app/Models/Product.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Product extends Model
{
    use HasFactory;
}
```

## Model ã®ä¿®æ­£

Model ã®æ›´æ–°ãŒã‚ã£ãŸã‚‰ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€`Illuminate\Database\Eloquent\BroadcastsEvents`ãƒˆãƒ¬ã‚¤ãƒˆã®`broadcastOn()`ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```PHP:app/Models/Product.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Product extends Model
{
    use HasFactory;

    public function broadcastOn(string $event): array
    {
        return ['products'];
    }
}
```

## DB ã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 

`routes/web.php`ã®`test`ã‚’æ”¹é€ ã—ã¾ã—ãŸã€‚
Product ãƒ†ãƒ¼ãƒ–ãƒ«ã® id ãŒ 3 ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®`stock_quantity`ã‚’+1 ã—ã¦ã„ã¾ã™ã€‚
ä¿å­˜å¾Œã€`products`ã‚¤ãƒ™ãƒ³ãƒˆã‚’ dispatch ã—ã¦ã„ã¾ã™ã€‚

`getEventDispatcher`ã¯ Model ãŒåˆ©ç”¨ã—ã¦ã„ã‚‹`HasEvents`ãƒˆãƒ¬ã‚¤ãƒˆã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ ğŸ§

```PHP:routs/web.php
Route::get('/test', function () {
    $product = Product::find(3);
    $product->increment('stock_quantity');
    $product->save();
    Product::getEventDispatcher()->dispatch('products');
});
```

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ä¿®æ­£

ã²ã¨ã¾ãšã€å—ã‘å–ã£ãŸå†…å®¹ã‚’ console ã«å‡ºåŠ›ã—ã¦ã¿ã¾ã™ã€‚

```PHP:resources/views/welcome.blade.php
const channel = pusher.subscribe('products');
  channel.bind('ProductUpdated', function (data) {
    console.log("åœ¨åº«" + data.model.stock_quantity);
});
```

## ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¦ã¿ã‚‹

ID ãŒ 3 ã®åº—é•·ã®åœ¨åº«æ•°ã«+1 ã—ãŸå€¤ãŒãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã¾ã—ãŸï¼
ï¼ˆè‰²ã€…ãŸã‚ã—ã¦ã„ãŸã‚‰ã„ã¤ã®é–“ã«ã‹ã ã„ã¶å¢—ãˆã¦ã¾ã—ãŸï¼‰

![ãƒ­ã‚°ã«å‡ºåŠ›](https://storage.googleapis.com/zenn-user-upload/f28e52e5c8e3-20231211.gif)

## å—ã‘å–ã£ãŸå€¤ã§ UI ã‚’æ›´æ–°ã—ã¦ã¿ã‚‹

View ã‚’ â†“ ã®ã‚ˆã†ãªå½¢ã«ã—ã¾ã™ã€‚

```PHP:resouces/views/welcome.blade.php
<!DOCTYPE html>

<head>
    <title>Pusher Test</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script>

        // Enable pusher logging - don't include this in production
        Pusher.logToConsole = true;

        const pusher = new Pusher("{{ $key }}", {
            cluster: "{{ $cluster }}"
        });

        const channel = pusher.subscribe('products');
        channel.bind('ProductUpdated', function (data) {
            const productId = data.model.id;
            const stockQuantity = data.model.stock_quantity;

            document.getElementById(`stock_quantity_${productId}`).innerText = stockQuantity;
        });
    </script>
</head>

<body>
    <h1>Pusher Test</h1>
    <table>
        <thead>
            <tr>
                <th>å•†å“å</th>
                <th>åœ¨åº«æ•°</th>
            </tr>
        </thead>
        <tbody>
            @foreach ($products as $product)
            <tr>
                <td>{{$product->product_name}}</td>
                <td id="stock_quantity_{{ $product->id }}">{{$product->stock_quantity}}</td>
            </tr>
            @endforeach
        </tbody>
    </table>
</body>
```

![](https://storage.googleapis.com/zenn-user-upload/a38060a64a54-20231212.gif)

åº—é•·ã®æ•°ãŒ 109â†’110 ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼

## ãŠã‚ã‚Š

ä»Šå›ã¯ã€Laravel ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ»Pusher ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã® UI æ›´æ–°ã‚’ãŸã‚ã—ã¦ã¿ã¾ã—ãŸã€‚

ã¾ã ã¾ã ç†è§£ã§ãã¦ã„ãªã„éƒ¨åˆ†ã‚‚å¤šã„ã§ã™ãŒã€â†“ ã¨ã„ã†èªè­˜ã§ã™ ğŸ§

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼šPusher ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦`products`ãƒãƒ£ãƒ³ãƒãƒ«ã‚’è³¼èª­ã€`productUpdated`ã‚¤ãƒ™ãƒ³ãƒˆãŒãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã•ã‚Œã‚‹ã¨ã€æŒ‡å®šã—ãŸå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆä»Šå›ã ã¨å—ã‘å–ã£ãŸåœ¨åº«æ•°ã§æ›´æ–°ã™ã‚‹ï¼‰
- Laravelï¼šã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ`productUpdated`ï¼‰ã‚’ç™ºç«ã•ã›ã¦ã€WebSocket ã‚µãƒ¼ãƒãƒ¼(Pusher)ã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚’ä¾é ¼ã™ã‚‹
- Pusherï¼šLaravel ã‹ã‚‰ä¾é ¼ãŒã‚ã‚Œã°ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã—ã¦ã€ãƒãƒ£ãƒ³ãƒãƒ«ã‚’è³¼èª­ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚“ã§ã„ã‚‹ã¨ã€èªè¨¼ãŒå¿…è¦ãªãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã‚„ã€Pusher ä»¥å¤–ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‰ãƒ©ã‚¤ãƒï¼ˆAbly ã‚„ Laravel WebSocket ãªã©)ã‚‚ã‚ã‚‹ã‚ˆã†ãªã®ã§ã€è‰²ã€…ãŸã‚ã—ã¦ã¿ã‚‹ã®ã‚‚ã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“â€¦ï¼

https://github.com/Masato0405/realtime_laravel
